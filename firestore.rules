rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is accessing their own data
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Collections ---

    // Users Collection
    match /users/{userId} {
      // Anyone signed in can view profiles
      allow read: if isAuthenticated();
      
      // Only the user can create or update their own profile
      allow create, update: if isAuthenticated() && isOwner(userId);
      
      // CRITICAL: Prevent deletion of user document by client (must be done via Admin SDK or Cloud Function if needed)
      // Exception: If we want to allow account deletion from client (which we implemented), we need to allow it.
      // But for safety, let's keep it restricted or strictly checked. 
      // The app uses `deleteAccount` which might rely on client-side delete if using standard SDK.
      // Let's check `user_service.dart`. It uses `batch.delete(...)`.
      // So we MUST allow delete if it is the owner.
      allow delete: if isAuthenticated() && isOwner(userId);
      
      // Subcollections: notifications, friendRequests
      match /notifications/{notificationId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      match /friendRequests/{requestId} {
         allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Posts Collection
    match /posts/{postId} {
      allow read: if isAuthenticated();
      
      // Create: Must be authenticated and authorId must match uid
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      
      // Update: Only author can update
      allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;
      
      // Delete: Only author can delete
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
      
      // Likes Subcollection
      match /likes/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(userId);
      }
      
      // Comments Subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
      }
    }
    
    // FriendRequests Collection (Root level - if used)
    // The app uses a root-level 'friendRequests' collection based on UserService.
    match /friendRequests/{requestId} {
      // Read: If you are sender or receiver
      allow read: if isAuthenticated() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
      
      // Create: If you are the sender
      allow create: if isAuthenticated() && request.resource.data.from == request.auth.uid;
      
      // Update: If you are sender or receiver (e.g. accepting)
      allow update: if isAuthenticated() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
      
      // Delete: Sender or receiver can delete
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
    }
    
    // Stories Collection
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
